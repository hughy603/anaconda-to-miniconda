name: Security Scanning

on:
  push:
    branches: [master, develop]
  pull_request:
    branches: [master, develop]
  schedule:
    - cron: '0 0 * * 1'  # Run weekly on Monday

env:
  PYTHON_VERSION: "3.11"
  UV_VERSION: "0.7.1"
  ACT_LOCAL_TESTING: ${{ vars.ACT_LOCAL_TESTING || 'false' }}

jobs:
  sonarqube:
    name: SonarQube Analysis
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Shallow clones should be disabled for better relevancy of analysis

      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install UV
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.cargo/bin" >> "$GITHUB_PATH"

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/uv
            ~/.cache/pip
          key: ${{ runner.os }}-py${{ env.PYTHON_VERSION }}-uv${{ env.UV_VERSION }}-security-${{ hashFiles('requirements.lock') }}
          restore-keys: |
            ${{ runner.os }}-py${{ env.PYTHON_VERSION }}-uv${{ env.UV_VERSION }}-security-

      - name: Install dependencies
        run: |
          uv pip install -e ".[test]" --system
          uv pip install hatch --system

      - name: Run tests with coverage
        run: |
          hatch run test

      # This step is skipped in local testing mode
      - name: SonarQube Scan (Production)
        uses: SonarSource/sonarqube-scan-action@v1
        if: ${{ !env.ACT_LOCAL_TESTING || env.ACT_LOCAL_TESTING != 'true' }}
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
        with:
          args: >
            -Dsonar.projectKey=conda-forge-converter
            -Dsonar.python.coverage.reportPaths=coverage.xml
            -Dsonar.sources=src
            -Dsonar.tests=tests
            -Dsonar.python.xunit.reportPath=pytest.xml
            -Dsonar.qualitygate.wait=true

      # This step only runs in local testing mode
      - name: Mock SonarQube Scan (Local Testing)
        if: ${{ env.ACT_LOCAL_TESTING == 'true' }}
        run: |
          echo "Mocking SonarQube scan for local testing"
          echo "In production, this would analyze code quality and security issues"
          echo "Coverage report generated at coverage.xml"
          echo "You can run local static analysis with: hatch run lint"

  secret-scanning:
    name: Secret Scanning Notification
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Secret Scanning Notice
        run: |
          echo "::notice::GitHub's built-in secret scanning should be enabled in the repository settings."
          echo "::notice::Go to Settings > Security > Code security and analysis > Secret scanning > Enable"

          # Check if we're running in a PR context
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            echo "::notice::Checking for potential secrets in this PR..."
            if [[ "${{ !env.ACT_LOCAL_TESTING || env.ACT_LOCAL_TESTING != 'true' }}" == "true" ]]; then
              git diff ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }} | \
              grep -E '(password|token|key|secret|credential).*[=:][^=:]*[a-zA-Z0-9_-]{16,}' || true
            else
              echo "::notice::Mock secret scanning for local testing"
              echo "::notice::In production, this would scan for potential secrets in the PR diff"
            fi
          fi
